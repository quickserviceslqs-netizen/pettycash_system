{% extends 'base.html' %}
{% load static %}

{% block title %}Maintenance Management{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Maintenance Management</h2>
    <a href="{% url 'settings_manager:dashboard' %}" class="btn btn-outline-secondary">Back to Settings</a>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">System Setting</h5>
          <p class="card-text">`SYSTEM_MAINTENANCE_MODE` value: <strong>{{ maintenance_setting_value }}</strong></p>
          {% if maintenance_setting %}
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="toggle_setting">
            <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if maintenance_setting.is_active %}checked{% endif %}>
              <label class="form-check-label" for="is_active">Setting is active</label>
            </div>
            <button class="btn btn-primary btn-sm" type="submit">Update Setting</button>
            <button class="btn btn-outline-secondary btn-sm" name="action" value="sync_to_session">Sync to Sessions</button>
          </form>
          {% else %}
            <p class="text-muted">No `SYSTEM_MAINTENANCE_MODE` setting found.</p>
          {% endif %}
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Create Maintenance Session</h5>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_session">
            <div class="mb-2">
              <label class="form-label">Reason</label>
              <input type="text" name="reason" class="form-control" placeholder="Maintenance reason" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Duration (minutes)</label>
              <input type="number" name="duration_minutes" class="form-control" value="30" min="5" max="1440">
            </div>
            <div class="mb-2 form-check">
              <input type="checkbox" name="notify_users" class="form-check-input" id="notify_users" checked>
              <label class="form-check-label" for="notify_users">Notify users</label>
            </div>
            <div class="mb-2">
              <label class="form-label">Custom message (optional)</label>
              <textarea name="custom_message" class="form-control" rows="3"></textarea>
            </div>
            <button class="btn btn-danger" type="submit">Activate Maintenance</button>
          </form>
        </div>
      </div>

    </div>

    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Active Session</h5>
          {% if active_session %}
            <p><strong>Activated At:</strong> {{ active_session.activated_at }}</p>
            <p><strong>Activated By:</strong> {{ active_session.activated_by }}</p>
            <p><strong>Reason:</strong> {{ active_session.reason }}</p>
            <p><strong>Expected Completion:</strong> {{ active_session.expected_completion }}</p>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="deactivate_session">
              <input type="hidden" name="session_id" value="{{ active_session.id }}">
              <div class="mb-2">
                <label class="form-label">Notes (optional)</label>
                <textarea name="notes" class="form-control" rows="2"></textarea>
              </div>
              <button class="btn btn-warning">Deactivate Session</button>
            </form>
          {% else %}
            <p class="text-muted">No active maintenance session.</p>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">History</h5>
          {% if history %}
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Activated At</th>
                  <th>By</th>
                  <th>Active</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody>
                {% for s in history %}
                  <tr>
                    <td>{{ s.activated_at }}</td>
                    <td>{{ s.activated_by }}</td>
                    <td>{% if s.is_active %}<span class="badge bg-danger">Active</span>{% else %}<span class="text-muted">No</span>{% endif %}</td>
                    <td>{{ s.reason|default:'-' }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="text-muted">No maintenance sessions recorded.</p>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Add confirmation prompts for potentially destructive actions
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('form').forEach(function(form){
    form.addEventListener('submit', function(e){
      var action = form.querySelector('input[name="action"]') ? form.querySelector('input[name="action"]').value : (form.querySelector('button[name="action"]') ? form.querySelector('button[name="action"]').value : null);
      if(!action){ return; }
      if(action === 'create_session'){
        if(!confirm('Activate maintenance now? This will block non-admin users from the site.')){ e.preventDefault(); }
      }
      if(action === 'deactivate_session'){
        if(!confirm('Deactivate the active maintenance session?')){ e.preventDefault(); }
      }
      if(action === 'sync_to_session'){
        if(!confirm('Sync system setting to maintenance sessions? This may create or deactivate sessions to match the boolean setting.')){ e.preventDefault(); }
      }
      if(action === 'toggle_setting'){
        var checked = form.querySelector('#is_active') ? form.querySelector('#is_active').checked : false;
        if(checked){
          if(!confirm('Enable SYSTEM_MAINTENANCE_MODE setting? This may affect site behavior.')){ e.preventDefault(); }
        }
      }
    }, {capture: true});
  });
});
</script>
{% endblock %}
