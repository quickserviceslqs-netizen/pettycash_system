{% extends "base.html" %}
{% load static %}

{% block title %}Requisition Details - {{ requisition.transaction_id }}{% endblock %}

{% block content %}
<h2>Requisition Details</h2>

<table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Transaction ID</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">{{ requisition.transaction_id }}</td>
    </tr>
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Requested By</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">{{ requisition.requested_by.get_display_name }}</td>
    </tr>
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Amount</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">{{ requisition.amount }}</td>
    </tr>
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Status</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">{{ requisition.status|title }}</td>
    </tr>
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Next Approver</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">
            {% if requisition.next_approver %}
                {{ requisition.next_approver.get_display_name }}
            {% else %}
                -
            {% endif %}
        </td>
    </tr>
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Purpose</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">{{ requisition.purpose }}</td>
    </tr>
</table>

<!-- Banner: cannot approve your own requisition -->
{% if user.id == requisition.requested_by.id %}
    <div style="padding:15px; background:#ffeeba; border:1px solid #ffc107; border-radius:5px; margin-bottom:20px;">
        You cannot approve your own requisition ‚Äî it will be routed to 
        {% if requisition.next_approver %}
            {{ requisition.next_approver.get_display_name }}
        {% else %}
            the next approver
        {% endif %}.
    </div>
{% endif %}

<!-- Approve/Reject buttons: only visible if user can act -->
{% if can_act %}
    <form method="post" action="{% url 'approve-requisition' requisition.transaction_id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" style="padding:10px 15px; background:#28a745; color:#fff; border:none; border-radius:5px; cursor:pointer;">
            Approve
        </button>
    </form>

    <form method="post" action="{% url 'reject-requisition' requisition.transaction_id %}" style="display:inline; margin-left:10px;">
        {% csrf_token %}
        <button type="submit" style="padding:10px 15px; background:#dc3545; color:#fff; border:none; border-radius:5px; cursor:pointer;">
            Reject
        </button>
    </form>
{% endif %}

<!-- Phase 4: Admin Override Button (Emergency Approval) -->
{% if user.is_superuser or user.role == 'admin' %}
    {% if requisition.status not in 'reviewed,paid,rejected' %}
        <div style="margin-top:20px; padding:15px; background:#fff3cd; border:1px solid #ffc107; border-radius:5px;">
            <h4 style="margin-top:0; color:#856404;">‚ö†Ô∏è Admin Override (Emergency Only)</h4>
            <p style="color:#856404; margin-bottom:10px;">
                Use this only in emergency situations. This action bypasses normal approval workflow and is fully logged for audit.
            </p>
            <form method="post" action="{% url 'admin-override' requisition.transaction_id %}" onsubmit="return confirm('Are you sure you want to override normal approval process? This action will be logged.');">
                {% csrf_token %}
                <textarea 
                    name="justification" 
                    placeholder="REQUIRED: Explain why admin override is necessary (e.g., emergency, all approvers unavailable, urgent payment needed)"
                    style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ffc107; border-radius:3px;"
                    rows="3"
                    required
                ></textarea>
                <button type="submit" style="padding:10px 15px; background:#ff9800; color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">
                    üö® Force Approve (Override)
                </button>
            </form>
        </div>
    {% endif %}
{% endif %}

{% endblock %}
