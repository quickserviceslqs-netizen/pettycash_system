{% extends "base.html" %}
{% load static %}

{% block title %}Requisition Details - {{ requisition.transaction_id }}{% endblock %}

{% block content %}
<h2>Requisition Details</h2>

<table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Transaction ID</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">{{ requisition.transaction_id }}</td>
    </tr>
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Requested By</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">{{ requisition.requested_by.get_display_name }}</td>
    </tr>
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Amount</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">{{ requisition.amount }}</td>
    </tr>
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Status</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">{{ requisition.status|title }}</td>
    </tr>
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Next Approver</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">
            {% if requisition.next_approver %}
                {{ requisition.next_approver.get_display_name }}
            {% else %}
                -
            {% endif %}
        </td>
    </tr>
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Purpose</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">{{ requisition.purpose }}</td>
    </tr>
    <tr>
        <th style="text-align:left; padding:8px; border-bottom:1px solid #ccc;">Receipt/Document</th>
        <td style="padding:8px; border-bottom:1px solid #ccc;">
            {% if requisition.receipt %}
                <a href="{{ requisition.receipt.url }}" target="_blank" style="display:inline-block; padding:8px 15px; background:#0d6efd; color:#fff; text-decoration:none; border-radius:5px; font-weight:bold;">
                    üìé View Receipt/Attachment
                </a>
            {% else %}
                <em style="color:#dc3545;">‚ö†Ô∏è No receipt uploaded</em>
            {% endif %}
        </td>
    </tr>
</table>

<!-- Treasury: Payment Execution Interface (for reviewed requisitions) -->
{% if can_execute_payment %}
    <div style="padding:20px; background:#e7f1ff; border:2px solid #0d6efd; border-radius:8px; margin:20px 0;">
        <h3 style="margin-top:0; color:#0d6efd;">üí∞ Execute Payment</h3>
        
        <!-- Validation Checklist -->
        <div style="padding:15px; background:#fff; border:1px solid #0d6efd; border-radius:5px; margin-bottom:20px;">
            <h4 style="margin-top:0; color:#084298;">üìã Pre-Payment Validation Checklist</h4>
            <ul style="margin-bottom:10px; color:#084298;">
                <li>‚úì Receipt/supporting document reviewed above</li>
                <li>‚úì Amount (KES {{requisition.amount|floatformat:2}}) matches documentation</li>
                <li>‚úì All required approvals completed</li>
                <li>‚úì Fund availability confirmed</li>
            </ul>
        </div>

        <!-- Payment Execution Form -->
        <form id="payment-form" style="background:#fff; padding:20px; border-radius:5px;">
            <h4 style="margin-top:0;">Payment Details</h4>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Amount (KES)</label>
                <input type="text" value="{{requisition.amount|floatformat:2}}" readonly 
                       style="width:100%; padding:10px; border:1px solid #ccc; border-radius:3px; background:#f8f9fa;">
            </div>

            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Payment Method</label>
                <select id="payment-method" required 
                        style="width:100%; padding:10px; border:1px solid #ccc; border-radius:3px;">
                    <option value="mpesa">M-Pesa</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="cash">Cash</option>
                </select>
            </div>

            <div id="mpesa-fields" style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Phone Number (M-Pesa)</label>
                <input type="tel" id="phone-number" placeholder="e.g., 254712345678" 
                       style="width:100%; padding:10px; border:1px solid #ccc; border-radius:3px;">
                <small style="color:#6c757d;">Format: 254XXXXXXXXX</small>
            </div>

            <div id="bank-fields" style="margin-bottom:15px; display:none;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Bank Account / Reference</label>
                <input type="text" id="destination" placeholder="Account number or reference" 
                       style="width:100%; padding:10px; border:1px solid #ccc; border-radius:3px;">
            </div>

            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">OTP Code</label>
                <input type="text" id="otp-code" required placeholder="Enter your OTP" 
                       style="width:100%; padding:10px; border:1px solid #ccc; border-radius:3px;">
                <button type="button" id="request-otp-btn" 
                        style="margin-top:5px; padding:5px 10px; background:#6c757d; color:#fff; border:none; border-radius:3px; cursor:pointer;">
                    üì± Request OTP
                </button>
            </div>

            <button type="submit" id="execute-payment-btn" 
                    style="padding:12px 25px; background:#0d6efd; color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:bold; font-size:16px;">
                üí∏ Execute Payment Now
            </button>
        </form>

        <div id="payment-status" style="margin-top:15px;"></div>
    </div>

    <script>
        // Toggle payment fields based on method
        document.getElementById('payment-method').addEventListener('change', function() {
            const mpesaFields = document.getElementById('mpesa-fields');
            const bankFields = document.getElementById('bank-fields');
            
            if (this.value === 'mpesa') {
                mpesaFields.style.display = 'block';
                bankFields.style.display = 'none';
            } else {
                mpesaFields.style.display = 'none';
                bankFields.style.display = 'block';
            }
        });

        // Request OTP
        document.getElementById('request-otp-btn').addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = '‚è≥ Sending...';

            try {
                const response = await fetch('/treasury/api/payments/{{payment.id}}/request_otp/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ OTP sent! Check your phone/email.');
                    btn.textContent = '‚úì OTP Sent';
                    btn.style.background = '#28a745';
                } else {
                    alert('‚ùå Failed to send OTP: ' + data.message);
                    btn.disabled = false;
                    btn.textContent = 'üì± Request OTP';
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üì± Request OTP';
            }
        });

        // Execute Payment
        document.getElementById('payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const method = document.getElementById('payment-method').value;
            const phoneNumber = document.getElementById('phone-number').value;
            const destination = document.getElementById('destination').value;
            const otpCode = document.getElementById('otp-code').value;
            const statusDiv = document.getElementById('payment-status');
            const btn = document.getElementById('execute-payment-btn');

            btn.disabled = true;
            btn.textContent = '‚è≥ Processing...';
            statusDiv.innerHTML = '<p style="color:#0d6efd;">‚è≥ Processing payment...</p>';

            try {
                const response = await fetch('/treasury/api/payments/{{payment.id}}/execute/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        method: method,
                        phone_number: phoneNumber,
                        destination: destination || phoneNumber,
                        otp_code: otpCode
                    })
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = `
                        <div style="padding:15px; background:#d1e7dd; border:1px solid #28a745; border-radius:5px;">
                            <h4 style="margin-top:0; color:#0f5132;">‚úÖ Payment Executed Successfully!</h4>
                            <p style="color:#0f5132; margin:0;">${data.message}</p>
                        </div>
                    `;
                    setTimeout(() => window.location.href = '/dashboard/', 2000);
                } else {
                    statusDiv.innerHTML = `
                        <div style="padding:15px; background:#f8d7da; border:1px solid #dc3545; border-radius:5px;">
                            <h4 style="margin-top:0; color:#842029;">‚ùå Payment Failed</h4>
                            <p style="color:#842029; margin:0;">${data.message}</p>
                        </div>
                    `;
                    btn.disabled = false;
                    btn.textContent = 'üí∏ Execute Payment Now';
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div style="padding:15px; background:#f8d7da; border:1px solid #dc3545; border-radius:5px;">
                        <h4 style="margin-top:0; color:#842029;">‚ùå Error</h4>
                        <p style="color:#842029; margin:0;">${error.message}</p>
                    </div>
                `;
                btn.disabled = false;
                btn.textContent = 'üí∏ Execute Payment Now';
            }
        });
    </script>
{% endif %}

<!-- Treasury: Approval validation checklist (only shown if they're in approval workflow - old requisitions) -->
{% if can_act and user.role == 'treasury' %}
    <div style="padding:15px; background:#cfe2ff; border:1px solid #0d6efd; border-radius:5px; margin-bottom:20px; margin-top:20px;">
        <h4 style="margin-top:0; color:#084298;">üìã Treasury Validation Checklist</h4>
        <ul style="margin-bottom:10px; color:#084298;">
            <li>‚úì Review receipt/supporting document above</li>
            <li>‚úì Verify amount matches documentation</li>
            <li>‚úì Confirm all required approvals completed</li>
            <li>‚úì Check fund availability before payment</li>
        </ul>
        <p style="color:#084298; margin:0; font-weight:bold;">
            Click "Validate & Pay" below to proceed with payment execution (OTP required)
        </p>
    </div>
{% endif %}

<!-- Banner: cannot approve your own requisition -->
{% if user.id == requisition.requested_by.id %}
    <div style="padding:15px; background:#ffeeba; border:1px solid #ffc107; border-radius:5px; margin-bottom:20px;">
        You cannot approve your own requisition ‚Äî it will be routed to 
        {% if requisition.next_approver %}
            {{ requisition.next_approver.get_display_name }}
        {% else %}
            the next approver
        {% endif %}.
    </div>
{% endif %}

<!-- Phase 3: Urgency Confirmation - First approver must confirm urgency before proceeding -->
{% if requisition.status == 'pending_urgency_confirmation' and can_act %}
    <div style="padding:15px; background:#fff3cd; border:1px solid #ffc107; border-radius:5px; margin-bottom:20px;">
        <h4 style="margin-top:0; color:#856404;">‚ö†Ô∏è Urgent Request - Confirmation Required</h4>
        <p style="color:#856404; margin-bottom:10px;">
            <strong>Urgency Reason:</strong> {{ requisition.urgency_reason }}
        </p>
        <p style="color:#856404; margin-bottom:15px;">
            As the first approver, please confirm this request is genuinely urgent before it proceeds to fast-track approval.
        </p>
        <form method="post" action="{% url 'confirm-urgency' requisition.transaction_id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" style="padding:10px 15px; background:#ff9800; color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">
                ‚úì Confirm Urgency & Approve
            </button>
        </form>
        <form method="post" action="{% url 'reject-requisition' requisition.transaction_id %}" style="display:inline; margin-left:10px;">
            {% csrf_token %}
            <button type="submit" style="padding:10px 15px; background:#dc3545; color:#fff; border:none; border-radius:5px; cursor:pointer;">
                ‚úó Reject (Not Urgent)
            </button>
        </form>
    </div>
{% endif %}

<!-- Approve/Reject buttons: only visible if user can act and NOT pending urgency confirmation -->
{% if can_act and requisition.status != 'pending_urgency_confirmation' %}
    <form method="post" action="{% url 'approve-requisition' requisition.transaction_id %}" style="display:inline;">
        {% csrf_token %}
        {% if user.role == 'treasury' %}
            <button type="submit" style="padding:10px 20px; background:#0d6efd; color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">
                ‚úì Validate & Pay
            </button>
        {% else %}
            <button type="submit" style="padding:10px 15px; background:#28a745; color:#fff; border:none; border-radius:5px; cursor:pointer;">
                Approve
            </button>
        {% endif %}
    </form>

    <form method="post" action="{% url 'reject-requisition' requisition.transaction_id %}" style="display:inline; margin-left:10px;">
        {% csrf_token %}
        <button type="submit" style="padding:10px 15px; background:#dc3545; color:#fff; border:none; border-radius:5px; cursor:pointer;">
            Reject
        </button>
    </form>
{% endif %}

<!-- Phase 4: Admin Override Button (Emergency Approval) -->
{% if user.is_superuser or user.role == 'admin' %}
    {% if requisition.status not in 'reviewed,paid,rejected' %}
        <div style="margin-top:20px; padding:15px; background:#fff3cd; border:1px solid #ffc107; border-radius:5px;">
            <h4 style="margin-top:0; color:#856404;">‚ö†Ô∏è Admin Override (Emergency Only)</h4>
            <p style="color:#856404; margin-bottom:10px;">
                Use this only in emergency situations. This action bypasses normal approval workflow and is fully logged for audit.
            </p>
            <form method="post" action="{% url 'admin-override' requisition.transaction_id %}" onsubmit="return confirm('Are you sure you want to override normal approval process? This action will be logged.');">
                {% csrf_token %}
                <textarea 
                    name="justification" 
                    placeholder="REQUIRED: Explain why admin override is necessary (e.g., emergency, all approvers unavailable, urgent payment needed)"
                    style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ffc107; border-radius:3px;"
                    rows="3"
                    required
                ></textarea>
                <button type="submit" style="padding:10px 15px; background:#ff9800; color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">
                    üö® Force Approve (Override)
                </button>
            </form>
        </div>
    {% endif %}
{% endif %}

<!-- Phase 4: Approval History with Escalation Details -->
{% if approval_trail %}
<div style="margin-top:30px;">
    <h3>Approval History</h3>
    <table style="width:100%; border-collapse:collapse;">
        <thead>
            <tr style="background:#f8f9fa;">
                <th style="text-align:left; padding:10px; border-bottom:2px solid #dee2e6;">Date/Time</th>
                <th style="text-align:left; padding:10px; border-bottom:2px solid #dee2e6;">Approver</th>
                <th style="text-align:left; padding:10px; border-bottom:2px solid #dee2e6;">Role</th>
                <th style="text-align:left; padding:10px; border-bottom:2px solid #dee2e6;">Action</th>
                <th style="text-align:left; padding:10px; border-bottom:2px solid #dee2e6;">Comment</th>
            </tr>
        </thead>
        <tbody>
            {% for trail in approval_trail %}
            <tr>
                <td style="padding:10px; border-bottom:1px solid #dee2e6;">
                    {{ trail.timestamp|date:"M d, Y H:i" }}
                </td>
                <td style="padding:10px; border-bottom:1px solid #dee2e6;">
                    {{ trail.user.get_display_name }}
                    {% if trail.auto_escalated %}
                        <span style="background:#ffc107; color:#000; padding:2px 6px; border-radius:3px; font-size:0.85em; margin-left:5px;">
                            ‚ö† Auto-escalated
                        </span>
                    {% endif %}
                    {% if trail.override %}
                        <span style="background:#dc3545; color:#fff; padding:2px 6px; border-radius:3px; font-size:0.85em; margin-left:5px;">
                            üö® Admin Override
                        </span>
                    {% endif %}
                </td>
                <td style="padding:10px; border-bottom:1px solid #dee2e6;">
                    {{ trail.role|title }}
                </td>
                <td style="padding:10px; border-bottom:1px solid #dee2e6;">
                    {% if trail.action == 'approved' %}
                        <span style="color:#28a745; font-weight:bold;">‚úì Approved</span>
                    {% elif trail.action == 'rejected' %}
                        <span style="color:#dc3545; font-weight:bold;">‚úó Rejected</span>
                    {% elif trail.action == 'urgency_confirmed' %}
                        <span style="color:#ff9800; font-weight:bold;">‚ö° Urgency Confirmed</span>
                    {% else %}
                        {{ trail.action|title }}
                    {% endif %}
                </td>
                <td style="padding:10px; border-bottom:1px solid #dee2e6;">
                    {{ trail.comment }}
                    {% if trail.escalation_reason %}
                        <div style="margin-top:5px; padding:8px; background:#fff3cd; border-left:3px solid #ffc107; font-size:0.9em;">
                            <strong>Escalation Reason:</strong> {{ trail.escalation_reason }}
                        </div>
                    {% endif %}
                    {% if trail.skipped_roles %}
                        <div style="margin-top:5px; padding:8px; background:#e7f3ff; border-left:3px solid #0d6efd; font-size:0.9em;">
                            <strong>Skipped Roles:</strong> {{ trail.skipped_roles|join:", " }}
                        </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endblock %}
