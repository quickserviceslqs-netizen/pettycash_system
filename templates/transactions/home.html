{% extends "base.html" %}
{% load static %}

{% block title %}Transactions - Petty Cash System{% endblock %}

{% block content %}
<div style="max-width:1200px; margin:0 auto;">

    <!-- Page Header -->
    <section style="margin-bottom:30px; text-align:center;">
        <h2 style="font-size:1.8rem; margin-bottom:5px;">Transactions</h2>
        <p style="font-size:1rem; color:#555;">
            Welcome, {{ user.get_display_name }}
            {% if is_centralized %}
                <span style="display:inline-block; margin-left:10px; padding:4px 12px; background:#17a2b8; color:#fff; border-radius:12px; font-size:0.85rem; font-weight:bold;">
                    üåê {{ scope_label }}
                </span>
            {% endif %}
        </p>
    </section>

    <!-- Button to Create New Requisition -->
    <div style="margin-bottom:30px; text-align:center;">
        <a href="{% url 'create-requisition' %}" 
           style="padding:10px 15px; background:#28a745; color:#fff; border-radius:5px; text-decoration:none;">
            + Create New Requisition
        </a>
    </div>

    <!-- Section: My Requisitions -->
    <section style="margin-bottom:40px;">
        <h3>My Requisitions</h3>
        {% if requisitions %}
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:#f2f2f2;">
                        <th style="padding:10px; border:1px solid #ddd;">ID</th>
                        <th style="padding:10px; border:1px solid #ddd;">Amount</th>
                        <th style="padding:10px; border:1px solid #ddd;">Status</th>
                        <th style="padding:10px; border:1px solid #ddd;">Next Approver</th>
                        <th style="padding:10px; border:1px solid #ddd;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requisitions %}
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd;">{{ req.transaction_id }}</td>
                        <td style="padding:10px; border:1px solid #ddd;">{{ req.amount }}</td>
                        <td style="padding:10px; border:1px solid #ddd;">
                            <span style="padding:2px 6px; border-radius:3px; background:
                                {% if req.status == 'pending' %}#ffc107
                                {% elif req.status == 'reviewed' %}#17a2b8
                                {% elif req.status == 'rejected' %}#dc3545
                                {% elif req.status == 'paid' %}#28a745
                                {% else %}#6c757d{% endif %};
                                color:#fff;">
                                {{ req.status|title }}
                            </span>
                        </td>
                        <td style="padding:10px; border:1px solid #ddd;">
                            {% if req.next_approver %}
                                {{ req.next_approver.get_display_name }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td style="padding:10px; border:1px solid #ddd;">
                            <a href="{% url 'requisition-detail' req.transaction_id %}" 
                               style="padding:5px 10px; background:#007bff; color:#fff; border-radius:3px; text-decoration:none;">
                               View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No requisitions created yet.</p>
        {% endif %}
    </section>

    <!-- Section: Ready for Payment (Treasury Only) -->
    {% if show_payment_section %}
    <section style="padding:20px; border:1px solid #0d6efd; border-radius:8px; background:#e7f1ff;">
        <h3 style="color:#0d6efd;">Ready for Payment Execution</h3>
        <p style="color:#084298;">Requisitions that have been fully approved and are ready for payment.</p>

        <table style="width:100%; border-collapse:collapse; background:#fff; margin-top:15px;">
            <thead>
                <tr style="background:#0d6efd; color:#fff;">
                    <th style="padding:10px; border:1px solid #ddd;">Transaction ID</th>
                    <th style="padding:10px; border:1px solid #ddd;">Requested By</th>
                    {% if is_centralized %}
                    <th style="padding:10px; border:1px solid #ddd;">Company</th>
                    {% endif %}
                    <th style="padding:10px; border:1px solid #ddd;">Amount (KES)</th>
                    <th style="padding:10px; border:1px solid #ddd;">Receipt</th>
                    <th style="padding:10px; border:1px solid #ddd;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for req in ready_for_payment %}
                <tr>
                    <td style="padding:10px; border:1px solid #ddd;">
                        <a href="{% url 'requisition-detail' req.transaction_id %}" style="color:#0d6efd; text-decoration:none;">
                            {{ req.transaction_id }}
                        </a>
                    </td>
                    <td style="padding:10px; border:1px solid #ddd;">{{ req.requested_by.get_display_name }}</td>
                    {% if is_centralized %}
                    <td style="padding:10px; border:1px solid #ddd;">
                        <span style="padding:2px 8px; background:#6c757d; color:#fff; border-radius:3px; font-size:0.85rem;">
                            {{ req.requested_by.company.name }}
                        </span>
                    </td>
                    {% endif %}
                    <td style="padding:10px; border:1px solid #ddd;">{{ req.amount|floatformat:2 }}</td>
                    <td style="padding:10px; border:1px solid #ddd;">
                        {% if req.receipt %}
                            <a href="{{ req.receipt.url }}" target="_blank" style="color:#0d6efd; text-decoration:none;">üìé View</a>
                        {% else %}
                            <span style="color:#dc3545;">‚ö†Ô∏è None</span>
                        {% endif %}
                    </td>
                    <td style="padding:10px; border:1px solid #ddd;">
                        <a href="{% url 'requisition-detail' req.transaction_id %}" style="padding:5px 10px; background:#0d6efd; color:#fff; text-decoration:none; border-radius:3px; font-weight:bold;">Execute Payment</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
    {% endif %}

    <!-- Section: Pending Approvals for Non-Treasury Approvers -->
    {% if show_pending_section %}
    <section>
        <h3>Requisitions Pending My Approval</h3>

        <table style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="background:#f2f2f2;">
                    <th style="padding:10px; border:1px solid #ddd;">ID</th>
                    <th style="padding:10px; border:1px solid #ddd;">Requested By</th>
                    {% if is_centralized %}
                    <th style="padding:10px; border:1px solid #ddd;">Company</th>
                    {% endif %}
                    <th style="padding:10px; border:1px solid #ddd;">Amount</th>
                    <th style="padding:10px; border:1px solid #ddd;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for req in pending_for_me %}
                <tr>
                    <td style="padding:10px; border:1px solid #ddd;">
                        <a href="{% url 'requisition-detail' req.transaction_id %}" style="color:#0d6efd; text-decoration:none;">
                            {{ req.transaction_id }}
                        </a>
                    </td>
                    <td style="padding:10px; border:1px solid #ddd;">{{ req.requested_by.get_display_name }}</td>
                    {% if is_centralized %}
                    <td style="padding:10px; border:1px solid #ddd;">
                        <span style="padding:2px 8px; background:#6c757d; color:#fff; border-radius:3px; font-size:0.85rem;">
                            {{ req.requested_by.company.name }}
                        </span>
                    </td>
                    {% endif %}
                    <td style="padding:10px; border:1px solid #ddd;">{{ req.amount }}</td>
                    <td style="padding:10px; border:1px solid #ddd;">
                        {% if req.requested_by != user %}
                            <a href="{% url 'requisition-detail' req.transaction_id %}" style="padding:5px 10px; background:#6c757d; color:#fff; text-decoration:none; border-radius:3px; display:inline-block; margin-right:5px;">View Details</a>
                            <form action="{% url 'approve-requisition' req.transaction_id %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" style="padding:5px 10px; background:#28a745; color:#fff; border:none; border-radius:3px;">Approve</button>
                            </form>
                            <form action="{% url 'reject-requisition' req.transaction_id %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" style="padding:5px 10px; background:#dc3545; color:#fff; border:none; border-radius:3px;">Reject</button>
                            </form>
                        {% else %}
                            <span style="color:#6c757d;">Cannot act on own requisition</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </section>
    {% endif %}

</div>
{% endblock %}
