{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - Petty Cash System{% endblock %}

{% block content %}
<div style="max-width:1200px; margin:0 auto;">

    <!-- Welcome Section -->
    <section style="margin-bottom:30px; text-align:center;">
        <h2 style="font-size:1.8rem; margin-bottom:5px;">Welcome, {{ user.get_display_name }}!</h2>
        <p style="color:#666; margin-top:5px;">
            <strong>Role:</strong> {{ user_role|title }} 
            {% if is_centralized %}
                <span style="display:inline-block; margin-left:10px; padding:4px 12px; background:#17a2b8; color:#fff; border-radius:12px; font-size:0.85rem; font-weight:bold;">
                    üåê {{ scope_label }}
                </span>
            {% else %}
                <span style="display:inline-block; margin-left:10px; padding:4px 12px; background:#6c757d; color:#fff; border-radius:12px; font-size:0.85rem;">
                    üè¢ {{ scope_label }}
                </span>
            {% endif %}
        </p>
    </section>

    <!-- No Apps Assigned Message -->
    {% if show_no_apps_cta %}
        <div style="padding:15px; background:#fff3cd; border:1px solid #ffeeba; color:#856404; border-radius:5px; text-align:center; margin-bottom:30px;">
            You currently have no apps assigned. Please contact Admin.
        </div>
    {% endif %}

    <!-- Dashboard Cards -->
    {% if navigation %}
    <section class="dashboard-cards" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:40px;">
        {% for app in navigation %}
            <div class="card" style="padding:20px; border:1px solid #ddd; border-radius:8px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.05); text-align:center;">
                <h3 style="margin-bottom:10px; font-size:1.2rem;">{{ app.name }}</h3>
                <a href="{{ app.url }}" style="display:inline-block; margin-top:10px; padding:8px 12px; background:#007bff; color:#fff; text-decoration:none; border-radius:5px; transition:0.3s;">
                    Go to {{ app.name }}
                </a>
            </div>
        {% endfor %}
    </section>
    {% endif %}

    <!-- Dashboard Stats -->
    <h3 style="margin-bottom:15px; color:#333;">
        My Dashboard Metrics
    </h3>
    <section class="dashboard-stats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:40px;">
        <!-- Personal Metrics: My Transactions -->
        <div class="stat-card" style="padding:20px; border:1px solid #ddd; border-radius:8px; background:#fff3cd; text-align:center;">
            <h4 style="margin-bottom:10px; color:#856404;">My Pending Transactions</h4>
            <p style="font-size:1.5rem; font-weight:bold; color:#856404;">{{ my_transactions_pending }}</p>
            <p style="font-size:0.85rem; color:#856404; margin-top:5px;">Transactions I created</p>
        </div>
        
        <!-- Personal Metrics: Pending My Approval -->
        {% if is_approver and user_role != 'treasury' %}
        <div class="stat-card" style="padding:20px; border:1px solid #ddd; border-radius:8px; background:#d1ecf1; text-align:center;">
            <h4 style="margin-bottom:10px; color:#0c5460;">Pending My Approval</h4>
            <p style="font-size:1.5rem; font-weight:bold; color:#0c5460;">{{ pending_my_approval }}</p>
            <p style="font-size:0.85rem; color:#0c5460; margin-top:5px;">Assigned to me</p>
        </div>
        {% endif %}
    </section>

    <!-- Company-Wide Metrics (For Treasury, FP&A, CEO, Centralized Approvers) -->
    {% if show_company_metrics %}
    <h3 style="margin-bottom:15px; color:#333; border-top:2px solid #ddd; padding-top:30px;">
        {% if user_role == 'treasury' %}
            Treasury Overview
        {% else %}
            Company Overview
        {% endif %}
        <span style="font-size:0.9rem; color:#666; font-weight:normal;">
            ({{ scope_label }})
        </span>
    </h3>
    <section class="dashboard-stats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:40px;">
        {% if user_role == 'treasury' %}
        <div class="stat-card" style="padding:20px; border:1px solid #ddd; border-radius:8px; background:#d4edda; text-align:center;">
            <h4 style="margin-bottom:10px; color:#155724;">Ready for Payment</h4>
            <p style="font-size:1.5rem; font-weight:bold; color:#155724;">{{ ready_for_payment_count }}</p>
            <p style="font-size:0.85rem; color:#155724; margin-top:5px;">Awaiting execution</p>
        </div>
        {% endif %}
        
        <div class="stat-card" style="padding:20px; border:1px solid #ddd; border-radius:8px; background:#f8f9fa; text-align:center;">
            <h4 style="margin-bottom:10px;">Total Pending Transactions</h4>
            <p style="font-size:1.2rem; font-weight:bold;">{{ total_transactions_pending }}</p>
        </div>
        <div class="stat-card" style="padding:20px; border:1px solid #ddd; border-radius:8px; background:#f8f9fa; text-align:center;">
            <h4 style="margin-bottom:10px;">Workflow Overdue</h4>
            <p style="font-size:1.2rem; font-weight:bold;">{{ workflow_overdue }}</p>
        </div>
        <div class="stat-card" style="padding:20px; border:1px solid #ddd; border-radius:8px; background:#f8f9fa; text-align:center;">
            <h4 style="margin-bottom:10px;">Reports Pending</h4>
            <p style="font-size:1.2rem; font-weight:bold;">{{ reports_pending }}</p>
        </div>
    </section>
    
    <!-- Company Breakdown for Centralized Treasury -->
    {% if company_breakdown %}
    <div style="margin-top:20px; padding:15px; background:#e7f1ff; border:1px solid #0d6efd; border-radius:8px;">
        <h4 style="margin-bottom:15px; color:#0d6efd;">Payments Ready by Company</h4>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:15px;">
            {% for company in company_breakdown %}
            <div style="padding:12px; background:#fff; border-radius:5px; text-align:center;">
                <p style="font-weight:bold; margin-bottom:5px; color:#333;">{{ company.name }}</p>
                <p style="font-size:1.3rem; font-weight:bold; color:#0d6efd;">{{ company.ready_for_payment }}</p>
                <p style="font-size:0.8rem; color:#666;">ready to execute</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Phase 4: Pending Approvals (Only for Non-Treasury Approvers) -->
    {% if show_pending_section and user_role != 'treasury' %}
    <section style="margin-bottom:40px;">
        <h3 style="margin-bottom:20px;">Pending Approvals</h3>
        {% if pending_for_user %}
            <p>You have {{ pending_for_user|length }} requisition(s) pending your approval.</p>
            <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                <thead>
                    <tr style="background:#f1f1f1;">
                        <th style="padding:10px; border:1px solid #ddd;">Transaction ID</th>
                        <th style="padding:10px; border:1px solid #ddd;">Requested By</th>
                        {% if is_centralized %}
                        <th style="padding:10px; border:1px solid #ddd;">Company</th>
                        {% endif %}
                        <th style="padding:10px; border:1px solid #ddd;">Amount</th>
                        <th style="padding:10px; border:1px solid #ddd;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in pending_for_user %}
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd;">{{ req.transaction_id }}</td>
                        <td style="padding:10px; border:1px solid #ddd;">{{ req.requested_by.get_display_name }}</td>
                        {% if is_centralized %}
                        <td style="padding:10px; border:1px solid #ddd;">
                            <span style="padding:2px 8px; background:#6c757d; color:#fff; border-radius:3px; font-size:0.85rem;">
                                {{ req.requested_by.company.name }}
                            </span>
                        </td>
                        {% endif %}
                        <td style="padding:10px; border:1px solid #ddd;">{{ req.amount }}</td>
                        <td style="padding:10px; border:1px solid #ddd;">
                            {% if req.requested_by.id != user.id %}
                                <a href="{% url 'approve-requisition' req.transaction_id %}" style="margin-right:10px; padding:5px 10px; background:#28a745; color:#fff; text-decoration:none; border-radius:4px;">Approve</a>
                                <a href="{% url 'reject-requisition' req.transaction_id %}" style="padding:5px 10px; background:#dc3545; color:#fff; text-decoration:none; border-radius:4px;">Reject</a>
                            {% else %}
                                <span style="color:#856404;">Cannot approve your own requisition</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No requisitions pending your approval.</p>
        {% endif %}
    </section>
    {% endif %}

    <!-- Ready for Payment Section (Treasury Only) -->
    {% if show_payment_section %}
    <section style="margin-top:30px; padding:20px; border:1px solid #0d6efd; border-radius:8px; background:#e7f1ff;">
        <h3 style="margin-bottom:20px; color:#0d6efd;">Ready for Payment Execution</h3>
        {% if ready_for_payment %}
            <p style="margin-bottom:15px;">You have {{ ready_for_payment|length }} requisition(s) ready for payment execution.</p>
            <table style="width:100%; border-collapse:collapse; background:#fff;">
                <thead style="background:#0d6efd; color:#fff;">
                    <tr>
                        <th style="padding:10px; border:1px solid #ddd; text-align:left;">Transaction ID</th>
                        <th style="padding:10px; border:1px solid #ddd; text-align:left;">Requested By</th>
                        {% if is_centralized %}
                        <th style="padding:10px; border:1px solid #ddd; text-align:left;">Company</th>
                        {% endif %}
                        <th style="padding:10px; border:1px solid #ddd; text-align:left;">Amount (KES)</th>
                        <th style="padding:10px; border:1px solid #ddd; text-align:left;">Receipt</th>
                        <th style="padding:10px; border:1px solid #ddd; text-align:left;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in ready_for_payment %}
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd;">{{ req.transaction_id }}</td>
                        <td style="padding:10px; border:1px solid #ddd;">{{ req.requested_by.get_display_name }}</td>
                        {% if is_centralized %}
                        <td style="padding:10px; border:1px solid #ddd;">
                            <span style="padding:2px 8px; background:#6c757d; color:#fff; border-radius:3px; font-size:0.85rem;">
                                {{ req.requested_by.company.name }}
                            </span>
                        </td>
                        {% endif %}
                        <td style="padding:10px; border:1px solid #ddd;">{{ req.amount|floatformat:2 }}</td>
                        <td style="padding:10px; border:1px solid #ddd;">
                            {% if req.receipt %}
                                <a href="{{ req.receipt.url }}" target="_blank" style="color:#0d6efd; text-decoration:none;">üìé View</a>
                            {% else %}
                                <span style="color:#dc3545;">‚ö†Ô∏è None</span>
                            {% endif %}
                        </td>
                        <td style="padding:10px; border:1px solid #ddd;">
                            <a href="{% url 'requisition-detail' req.transaction_id %}" style="margin-right:10px; padding:5px 10px; background:#0d6efd; color:#fff; text-decoration:none; border-radius:4px; font-weight:bold;">Execute Payment</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No requisitions ready for payment.</p>
        {% endif %}
    </section>
    {% endif %}

    <!-- Admin/Staff User Management Section -->
    {% if show_admin_section %}
    <h3 style="margin-bottom:15px; color:#333; border-top:2px solid #ddd; padding-top:30px;">
        <i class="bi bi-shield-fill-check"></i> Admin & User Management
    </h3>
    <section class="dashboard-stats" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:30px;">
        <div class="stat-card" style="padding:20px; border:1px solid #0d6efd; border-radius:8px; background:#cfe2ff; text-align:center;">
            <h4 style="margin-bottom:10px; color:#084298;">Total Users</h4>
            <p style="font-size:1.5rem; font-weight:bold; color:#084298;">{{ total_users }}</p>
            <a href="{% url 'accounts:manage_users' %}" style="display:inline-block; margin-top:10px; padding:6px 12px; background:#0d6efd; color:#fff; text-decoration:none; border-radius:4px; font-size:0.85rem;">
                Manage Users
            </a>
        </div>
        
        <div class="stat-card" style="padding:20px; border:1px solid #198754; border-radius:8px; background:#d1e7dd; text-align:center;">
            <h4 style="margin-bottom:10px; color:#0f5132;">Active Users</h4>
            <p style="font-size:1.5rem; font-weight:bold; color:#0f5132;">{{ active_users }}</p>
            <p style="font-size:0.85rem; color:#0f5132; margin-top:5px;">Can login</p>
        </div>
        
        <div class="stat-card" style="padding:20px; border:1px solid #ffc107; border-radius:8px; background:#fff3cd; text-align:center;">
            <h4 style="margin-bottom:10px; color:#664d03;">Pending Invitations</h4>
            <p style="font-size:1.5rem; font-weight:bold; color:#664d03;">{{ pending_invitations }}</p>
            <a href="{% url 'accounts:manage_invitations' %}" style="display:inline-block; margin-top:10px; padding:6px 12px; background:#ffc107; color:#000; text-decoration:none; border-radius:4px; font-size:0.85rem;">
                View Invitations
            </a>
        </div>
        
        <div class="stat-card" style="padding:20px; border:1px solid #dc3545; border-radius:8px; background:#f8d7da; text-align:center;">
            <h4 style="margin-bottom:10px; color:#842029;">Locked Users</h4>
            <p style="font-size:1.5rem; font-weight:bold; color:#842029;">{{ locked_users }}</p>
            <a href="{% url 'accounts:manage_users' %}" style="display:inline-block; margin-top:10px; padding:6px 12px; background:#dc3545; color:#fff; text-decoration:none; border-radius:4px; font-size:0.85rem;">
                Review Users
            </a>
        </div>
    </section>
    
    <!-- Quick Admin Actions -->
    <div style="padding:20px; border:1px solid #ddd; border-radius:8px; background:#f8f9fa; margin-bottom:30px;">
        <h5 style="margin-bottom:15px;"><i class="bi bi-lightning-fill"></i> Quick Admin Actions</h5>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
            <a href="{% url 'accounts:manage_users' %}" class="btn btn-primary" style="display:block; padding:10px; background:#0d6efd; color:#fff; text-decoration:none; border-radius:5px; text-align:center;">
                <i class="bi bi-people"></i> Manage Users
            </a>
            <a href="{% url 'accounts:bulk_import' %}" class="btn btn-success" style="display:block; padding:10px; background:#198754; color:#fff; text-decoration:none; border-radius:5px; text-align:center;">
                <i class="bi bi-file-earmark-arrow-up"></i> Bulk Import Users
            </a>
            <a href="{% url 'organization:import_organizations' %}" class="btn btn-info" style="display:block; padding:10px; background:#0dcaf0; color:#000; text-decoration:none; border-radius:5px; text-align:center;">
                <i class="bi bi-building"></i> Import Organizations
            </a>
            <a href="{% url 'accounts:manage_invitations' %}" class="btn btn-warning" style="display:block; padding:10px; background:#ffc107; color:#000; text-decoration:none; border-radius:5px; text-align:center;">
                <i class="bi bi-envelope-fill"></i> Manage Invitations
            </a>
        </div>
    </div>
    
    <!-- Top Users by Role -->
    {% if users_by_role %}
    <div style="padding:20px; border:1px solid #ddd; border-radius:8px; background:#fff; margin-bottom:30px;">
        <h5 style="margin-bottom:15px;"><i class="bi bi-bar-chart-fill"></i> Users by Role (Top 5)</h5>
        <table class="table table-sm" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="background:#f8f9fa;">
                    <th style="padding:10px; text-align:left; border-bottom:2px solid #dee2e6;">Role</th>
                    <th style="padding:10px; text-align:right; border-bottom:2px solid #dee2e6;">Count</th>
                </tr>
            </thead>
            <tbody>
                {% for role_stat in users_by_role %}
                <tr>
                    <td style="padding:10px; border-bottom:1px solid #dee2e6;">{{ role_stat.role|title }}</td>
                    <td style="padding:10px; text-align:right; border-bottom:1px solid #dee2e6;">
                        <span style="padding:3px 10px; background:#0d6efd; color:#fff; border-radius:12px; font-weight:bold;">{{ role_stat.count }}</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    {% endif %}

</div>
{% endblock %}
